# Sales Map Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a "Sales Map" tab that parses Etsy sold-orders CSVs into localStorage, deduplicates by Order ID, and renders choropleth maps of sales by US state and by country with breakdown tables.

**Architecture:** CSV is parsed client-side with a custom parser (no extra library). Records are stored in localStorage as JSON. Derived stats (by state, by country) are computed on render via `useMemo`. `react-simple-maps` renders SVG choropleths using CDN-hosted TopoJSON (internet required). No geocoding or API key needed.

**Tech Stack:** React 19, TypeScript (strict), Tailwind CSS v4, `react-simple-maps`, Lucide React icons. No test framework configured in this project — verify with `npm run dev`.

---

## Task 1: Install react-simple-maps

**Files:**
- Modify: `package.json` (via npm)

**Step 1: Install the library**

```bash
npm install react-simple-maps
```

Expected output: `added N packages` with no errors.

**Step 2: Verify TypeScript types are bundled**

```bash
ls node_modules/react-simple-maps/dist/*.d.ts
```

Expected: `.d.ts` file(s) present (types are bundled with the package, no `@types/` needed).

**Step 3: Commit**

```bash
git add package.json package-lock.json
git commit -m "chore: install react-simple-maps"
```

---

## Task 2: Add `SaleRecord` type and extend `View` union

**Files:**
- Modify: `src/types/index.ts`
- Modify: `src/App.tsx`

**Step 1: Add `SaleRecord` to types**

In `src/types/index.ts`, append at the end:

```ts
export interface SaleRecord {
  orderId: string;
  saleDate: string;
  fullName: string;
  shipCity: string;
  shipState: string;    // 2-letter code for US; may be empty for international
  shipCountry: string;  // full country name as in the CSV
  orderValue: number;
  numItems: number;
}
```

**Step 2: Extend `View` union in `src/App.tsx`**

Change line 9:

```ts
// Before:
export type View = 'dashboard' | 'inventory' | 'orders' | 'charts' | 'seo';

// After:
export type View = 'dashboard' | 'inventory' | 'orders' | 'charts' | 'seo' | 'salesmap';
```

**Step 3: Commit**

```bash
git add src/types/index.ts src/App.tsx
git commit -m "feat(salesmap): add SaleRecord type and salesmap view key"
```

---

## Task 3: CSV parser

**Files:**
- Create: `src/lib/parseSalesCsv.ts`

The Etsy CSV has these column indices (0-based):
- 0: Sale Date, 1: Order ID, 3: Full Name, 6: Number of Items
- 11: Ship City, 12: Ship State, 14: Ship Country, 16: Order Value

```ts
import type { SaleRecord } from '@/types';

// Column indices in the Etsy sold-orders CSV export
const COL = {
  saleDate: 0,
  orderId: 1,
  fullName: 3,
  numItems: 6,
  shipCity: 11,
  shipState: 12,
  shipCountry: 14,
  orderValue: 16,
} as const;

/** Splits a single CSV line into fields, respecting double-quoted values. */
function splitCsvLine(line: string): string[] {
  const fields: string[] = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      fields.push(current);
      current = '';
    } else {
      current += ch;
    }
  }
  fields.push(current);
  return fields;
}

function parseRow(fields: string[]): SaleRecord | null {
  const orderId = fields[COL.orderId]?.trim();
  if (!orderId) return null;
  return {
    orderId,
    saleDate: fields[COL.saleDate]?.trim() ?? '',
    fullName: fields[COL.fullName]?.trim() ?? '',
    shipCity: fields[COL.shipCity]?.trim() ?? '',
    shipState: fields[COL.shipState]?.trim() ?? '',
    shipCountry: fields[COL.shipCountry]?.trim() ?? '',
    orderValue: parseFloat(fields[COL.orderValue] ?? '0') || 0,
    numItems: parseInt(fields[COL.numItems] ?? '0', 10) || 0,
  };
}

export interface ParseResult {
  records: SaleRecord[];
  parseErrors: number;
}

export function parseSalesCsv(text: string): ParseResult {
  const lines = text.split('\n').filter(Boolean);
  const [, ...dataLines] = lines; // skip header row
  let parseErrors = 0;
  const records: SaleRecord[] = [];
  for (const line of dataLines) {
    const fields = splitCsvLine(line.trim());
    const record = parseRow(fields);
    if (record) {
      records.push(record);
    } else {
      parseErrors++;
    }
  }
  return { records, parseErrors };
}
```

**Step 1: Commit**

```bash
git add src/lib/parseSalesCsv.ts
git commit -m "feat(salesmap): add CSV parser for Etsy sold-orders format"
```

---

## Task 4: `useSalesOrders` hook

**Files:**
- Create: `src/hooks/useSalesOrders.ts`

```ts
import { useState, useCallback } from 'react';
import type { SaleRecord } from '@/types';

const STORAGE_KEY = 'salesmap_orders';

function load(): SaleRecord[] {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    return JSON.parse(raw) as SaleRecord[];
  } catch {
    return [];
  }
}

function save(records: SaleRecord[]): void {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
}

export interface MergeResult {
  added: number;
  duplicates: number;
}

export function useSalesOrders() {
  const [orders, setOrders] = useState<SaleRecord[]>(() => load());

  const merge = useCallback((incoming: SaleRecord[]): MergeResult => {
    const existing = load();
    const existingIds = new Set(existing.map((r) => r.orderId));
    const newRecords = incoming.filter((r) => !existingIds.has(r.orderId));
    const merged = [...existing, ...newRecords];
    save(merged);
    setOrders(merged);
    return { added: newRecords.length, duplicates: incoming.length - newRecords.length };
  }, []);

  const clear = useCallback(() => {
    localStorage.removeItem(STORAGE_KEY);
    setOrders([]);
  }, []);

  return { orders, merge, clear };
}
```

**Step 1: Commit**

```bash
git add src/hooks/useSalesOrders.ts
git commit -m "feat(salesmap): add useSalesOrders hook with localStorage persistence"
```

---

## Task 5: Geo lookup tables and derived data helpers

**Files:**
- Create: `src/lib/geoLookup.ts`
- Create: `src/lib/salesMapData.ts`

**`src/lib/geoLookup.ts`:**

```ts
/** Maps 2-letter US state abbreviation → full name as used in US Atlas TopoJSON */
export const STATE_ABBR_TO_NAME: Record<string, string> = {
  AL: 'Alabama', AK: 'Alaska', AZ: 'Arizona', AR: 'Arkansas',
  CA: 'California', CO: 'Colorado', CT: 'Connecticut', DE: 'Delaware',
  FL: 'Florida', GA: 'Georgia', HI: 'Hawaii', ID: 'Idaho',
  IL: 'Illinois', IN: 'Indiana', IA: 'Iowa', KS: 'Kansas',
  KY: 'Kentucky', LA: 'Louisiana', ME: 'Maine', MD: 'Maryland',
  MA: 'Massachusetts', MI: 'Michigan', MN: 'Minnesota', MS: 'Mississippi',
  MO: 'Missouri', MT: 'Montana', NE: 'Nebraska', NV: 'Nevada',
  NH: 'New Hampshire', NJ: 'New Jersey', NM: 'New Mexico', NY: 'New York',
  NC: 'North Carolina', ND: 'North Dakota', OH: 'Ohio', OK: 'Oklahoma',
  OR: 'Oregon', PA: 'Pennsylvania', RI: 'Rhode Island', SC: 'South Carolina',
  SD: 'South Dakota', TN: 'Tennessee', TX: 'Texas', UT: 'Utah',
  VT: 'Vermont', VA: 'Virginia', WA: 'Washington', WV: 'West Virginia',
  WI: 'Wisconsin', WY: 'Wyoming', DC: 'District of Columbia',
};

/**
 * Normalizes CSV country names to match world-atlas TopoJSON country names.
 * Only entries that differ need to be listed here.
 */
const COUNTRY_NORMALIZE: Record<string, string> = {
  'United States': 'United States of America',
  'The Netherlands': 'Netherlands',
};

export function normalizeCountry(name: string): string {
  return COUNTRY_NORMALIZE[name] ?? name;
}
```

**`src/lib/salesMapData.ts`:**

```ts
import type { SaleRecord } from '@/types';
import { STATE_ABBR_TO_NAME, normalizeCountry } from './geoLookup';

export interface RegionStat {
  key: string;     // state abbreviation or raw CSV country name
  label: string;   // display-friendly name
  count: number;
  revenue: number;
}

export function statsByUsState(orders: SaleRecord[]): RegionStat[] {
  const map = new Map<string, RegionStat>();
  for (const o of orders) {
    if (o.shipCountry !== 'United States') continue;
    const abbr = o.shipState.toUpperCase();
    if (!abbr) continue;
    const existing = map.get(abbr);
    if (existing) {
      existing.count++;
      existing.revenue += o.orderValue;
    } else {
      map.set(abbr, {
        key: abbr,
        label: STATE_ABBR_TO_NAME[abbr] ?? abbr,
        count: 1,
        revenue: o.orderValue,
      });
    }
  }
  return [...map.values()].sort((a, b) => b.count - a.count);
}

export function statsByCountry(orders: SaleRecord[]): RegionStat[] {
  const map = new Map<string, RegionStat>();
  for (const o of orders) {
    const key = o.shipCountry.trim();
    if (!key) continue;
    const existing = map.get(key);
    if (existing) {
      existing.count++;
      existing.revenue += o.orderValue;
    } else {
      map.set(key, { key, label: key, count: 1, revenue: o.orderValue });
    }
  }
  return [...map.values()].sort((a, b) => b.count - a.count);
}
```

**Step 1: Commit**

```bash
git add src/lib/geoLookup.ts src/lib/salesMapData.ts
git commit -m "feat(salesmap): add geo lookup tables and derived stat helpers"
```

---

## Task 6: Upload component

**Files:**
- Create: `src/components/salesmap/SalesMapUpload.tsx`

```tsx
import { useRef, useState } from 'react';
import { Upload, Trash2 } from 'lucide-react';
import { parseSalesCsv } from '@/lib/parseSalesCsv';
import type { SaleRecord } from '@/types';
import type { MergeResult } from '@/hooks/useSalesOrders';

interface SalesMapUploadProps {
  onMerge: (records: SaleRecord[]) => MergeResult;
  onClear: () => void;
  totalOrders: number;
}

export function SalesMapUpload({ onMerge, onClear, totalOrders }: SalesMapUploadProps) {
  const inputRef = useRef<HTMLInputElement>(null);
  const [dragging, setDragging] = useState(false);
  const [lastResult, setLastResult] = useState<MergeResult | null>(null);
  const [confirmClear, setConfirmClear] = useState(false);

  async function processFile(file: File) {
    const text = await file.text();
    const { records } = parseSalesCsv(text);
    const result = onMerge(records);
    setLastResult(result);
  }

  function handleFiles(files: FileList | null) {
    if (!files?.[0]) return;
    void processFile(files[0]);
  }

  return (
    <div className="flex flex-col sm:flex-row items-start sm:items-center gap-3">
      <div
        className={`flex-1 flex items-center gap-3 border-2 border-dashed rounded-xl px-4 py-3 cursor-pointer transition-colors ${
          dragging
            ? 'border-blue-400 bg-blue-50 dark:bg-blue-500/10'
            : 'border-slate-300 dark:border-slate-600 hover:border-blue-400 hover:bg-blue-50/50 dark:hover:bg-blue-500/5'
        }`}
        onClick={() => inputRef.current?.click()}
        onDragOver={(e) => {
          e.preventDefault();
          setDragging(true);
        }}
        onDragLeave={() => setDragging(false)}
        onDrop={(e) => {
          e.preventDefault();
          setDragging(false);
          handleFiles(e.dataTransfer.files);
        }}
      >
        <Upload size={16} className="text-slate-400 shrink-0" />
        <span className="text-slate-500 dark:text-slate-400 text-sm">
          {totalOrders > 0
            ? `${totalOrders.toLocaleString()} orders loaded — drop another CSV to merge`
            : 'Drop Etsy sold-orders CSV here, or click to browse'}
        </span>
        {lastResult && (
          <span className="ml-auto text-xs font-medium text-green-600 dark:text-green-400 shrink-0">
            +{lastResult.added} new · {lastResult.duplicates} skipped
          </span>
        )}
        <input
          ref={inputRef}
          type="file"
          accept=".csv"
          className="hidden"
          onChange={(e) => handleFiles(e.target.files)}
        />
      </div>

      {totalOrders > 0 &&
        (confirmClear ? (
          <div className="flex items-center gap-2 shrink-0">
            <span className="text-sm text-slate-500 dark:text-slate-400">Clear all data?</span>
            <button
              onClick={() => {
                onClear();
                setLastResult(null);
                setConfirmClear(false);
              }}
              className="text-xs px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg cursor-pointer border-none transition-colors"
            >
              Yes
            </button>
            <button
              onClick={() => setConfirmClear(false)}
              className="text-xs px-2 py-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg cursor-pointer border-none transition-colors"
            >
              No
            </button>
          </div>
        ) : (
          <button
            onClick={() => setConfirmClear(true)}
            className="flex items-center gap-1.5 text-xs px-3 py-2 text-red-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-500/10 rounded-xl transition-colors cursor-pointer border-none bg-transparent shrink-0"
          >
            <Trash2 size={14} />
            Clear All
          </button>
        ))}
    </div>
  );
}
```

**Step 1: Commit**

```bash
git add src/components/salesmap/SalesMapUpload.tsx
git commit -m "feat(salesmap): add CSV upload component with drag-and-drop"
```

---

## Task 7: US choropleth map component

**Files:**
- Create: `src/components/salesmap/UsMap.tsx`

Uses CDN-hosted US Atlas TopoJSON. Geo features have `properties.name` = full state name.
The `choroplethColor` helper interpolates from blue-200 (`#bfdbfe`) to blue-700 (`#1d4ed8`).

```tsx
import { useState } from 'react';
import { ComposableMap, Geographies, Geography } from 'react-simple-maps';
import type { RegionStat } from '@/lib/salesMapData';
import { STATE_ABBR_TO_NAME } from '@/lib/geoLookup';

const GEO_URL = 'https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json';

function buildNameMap(stats: RegionStat[]): Map<string, RegionStat> {
  const m = new Map<string, RegionStat>();
  for (const stat of stats) {
    const name = STATE_ABBR_TO_NAME[stat.key];
    if (name) m.set(name, stat);
  }
  return m;
}

function choroplethColor(count: number, max: number, isDark: boolean): string {
  if (count === 0 || max === 0) return isDark ? '#1e293b' : '#e2e8f0';
  const t = count / max;
  // Interpolate blue-200 (#bfdbfe) → blue-700 (#1d4ed8)
  const r = Math.round(191 + t * (29 - 191));
  const g = Math.round(219 + t * (78 - 219));
  const b = Math.round(254 + t * (216 - 254));
  return `rgb(${r},${g},${b})`;
}

interface Tooltip {
  x: number;
  y: number;
  name: string;
  count: number;
  revenue: number;
}

interface UsMapProps {
  stats: RegionStat[];
  isDark: boolean;
}

export function UsMap({ stats, isDark }: UsMapProps) {
  const [tooltip, setTooltip] = useState<Tooltip | null>(null);
  const nameMap = buildNameMap(stats);
  const max = Math.max(...stats.map((s) => s.count), 1);
  const strokeColor = isDark ? '#334155' : '#ffffff';

  return (
    <div className="relative w-full">
      <ComposableMap
        projection="geoAlbersUsa"
        projectionConfig={{ scale: 1000 }}
        style={{ width: '100%', height: 'auto' }}
      >
        <Geographies geography={GEO_URL}>
          {({ geographies }) =>
            geographies.map((geo) => {
              const name = geo.properties.name as string;
              const stat = nameMap.get(name);
              const count = stat?.count ?? 0;
              return (
                <Geography
                  key={geo.rsmKey}
                  geography={geo}
                  fill={choroplethColor(count, max, isDark)}
                  stroke={strokeColor}
                  strokeWidth={0.5}
                  style={{ outline: 'none' }}
                  onMouseEnter={(evt) =>
                    setTooltip({ x: evt.clientX, y: evt.clientY, name, count, revenue: stat?.revenue ?? 0 })
                  }
                  onMouseMove={(evt) =>
                    setTooltip((t) => (t ? { ...t, x: evt.clientX, y: evt.clientY } : null))
                  }
                  onMouseLeave={() => setTooltip(null)}
                />
              );
            })
          }
        </Geographies>
      </ComposableMap>
      {tooltip && (
        <div
          className="fixed z-50 pointer-events-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 shadow-lg text-sm"
          style={{ left: tooltip.x + 12, top: tooltip.y - 40 }}
        >
          <p className="font-semibold text-slate-900 dark:text-white">{tooltip.name}</p>
          <p className="text-slate-500 dark:text-slate-400">
            {tooltip.count} {tooltip.count === 1 ? 'order' : 'orders'} · ${tooltip.revenue.toFixed(2)}
          </p>
        </div>
      )}
    </div>
  );
}
```

**Step 1: Commit**

```bash
git add src/components/salesmap/UsMap.tsx
git commit -m "feat(salesmap): add US state choropleth map"
```

---

## Task 8: World choropleth map component

**Files:**
- Create: `src/components/salesmap/WorldMap.tsx`

World Atlas TopoJSON country names differ slightly from CSV (e.g., "United States of America" vs "United States"). Use `normalizeCountry` to align them.

```tsx
import { useState } from 'react';
import { ComposableMap, Geographies, Geography } from 'react-simple-maps';
import type { RegionStat } from '@/lib/salesMapData';
import { normalizeCountry } from '@/lib/geoLookup';

const GEO_URL = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';

function buildCountryMap(stats: RegionStat[]): Map<string, RegionStat> {
  const m = new Map<string, RegionStat>();
  for (const stat of stats) {
    m.set(normalizeCountry(stat.key), stat);
  }
  return m;
}

function choroplethColor(count: number, max: number, isDark: boolean): string {
  if (count === 0 || max === 0) return isDark ? '#1e293b' : '#e2e8f0';
  const t = count / max;
  const r = Math.round(191 + t * (29 - 191));
  const g = Math.round(219 + t * (78 - 219));
  const b = Math.round(254 + t * (216 - 254));
  return `rgb(${r},${g},${b})`;
}

interface Tooltip {
  x: number;
  y: number;
  name: string;
  count: number;
  revenue: number;
}

interface WorldMapProps {
  stats: RegionStat[];
  isDark: boolean;
}

export function WorldMap({ stats, isDark }: WorldMapProps) {
  const [tooltip, setTooltip] = useState<Tooltip | null>(null);
  const countryMap = buildCountryMap(stats);
  const max = Math.max(...stats.map((s) => s.count), 1);
  const strokeColor = isDark ? '#334155' : '#ffffff';

  return (
    <div className="relative w-full">
      <ComposableMap
        projectionConfig={{ scale: 130 }}
        style={{ width: '100%', height: 'auto' }}
      >
        <Geographies geography={GEO_URL}>
          {({ geographies }) =>
            geographies.map((geo) => {
              const name = geo.properties.name as string;
              const stat = countryMap.get(name);
              const count = stat?.count ?? 0;
              return (
                <Geography
                  key={geo.rsmKey}
                  geography={geo}
                  fill={choroplethColor(count, max, isDark)}
                  stroke={strokeColor}
                  strokeWidth={0.3}
                  style={{ outline: 'none' }}
                  onMouseEnter={(evt) =>
                    setTooltip({ x: evt.clientX, y: evt.clientY, name, count, revenue: stat?.revenue ?? 0 })
                  }
                  onMouseMove={(evt) =>
                    setTooltip((t) => (t ? { ...t, x: evt.clientX, y: evt.clientY } : null))
                  }
                  onMouseLeave={() => setTooltip(null)}
                />
              );
            })
          }
        </Geographies>
      </ComposableMap>
      {tooltip && (
        <div
          className="fixed z-50 pointer-events-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 shadow-lg text-sm"
          style={{ left: tooltip.x + 12, top: tooltip.y - 40 }}
        >
          <p className="font-semibold text-slate-900 dark:text-white">{tooltip.name}</p>
          <p className="text-slate-500 dark:text-slate-400">
            {tooltip.count} {tooltip.count === 1 ? 'order' : 'orders'} · ${tooltip.revenue.toFixed(2)}
          </p>
        </div>
      )}
    </div>
  );
}
```

**Step 1: Commit**

```bash
git add src/components/salesmap/WorldMap.tsx
git commit -m "feat(salesmap): add world country choropleth map"
```

---

## Task 9: Breakdown tables component

**Files:**
- Create: `src/components/salesmap/SalesBreakdownTables.tsx`

```tsx
import type { RegionStat } from '@/lib/salesMapData';

interface TableProps {
  title: string;
  rows: RegionStat[];
  labelHeader: string;
}

function BreakdownTable({ title, rows, labelHeader }: TableProps) {
  return (
    <div className="bg-white dark:bg-slate-800/60 rounded-2xl border border-slate-200 dark:border-slate-700/50 overflow-hidden shadow-sm">
      <div className="px-4 py-3 border-b border-slate-100 dark:border-slate-700/50">
        <h3 className="text-slate-500 dark:text-slate-400 font-semibold text-xs uppercase tracking-widest">
          {title}
        </h3>
      </div>
      <div className="overflow-y-auto max-h-72">
        <table className="w-full text-sm">
          <thead>
            <tr className="border-b border-slate-100 dark:border-slate-700/50">
              <th className="text-left px-4 py-2 text-slate-500 dark:text-slate-400 font-medium text-xs">
                {labelHeader}
              </th>
              <th className="text-right px-4 py-2 text-slate-500 dark:text-slate-400 font-medium text-xs">
                Orders
              </th>
              <th className="text-right px-4 py-2 text-slate-500 dark:text-slate-400 font-medium text-xs">
                Revenue
              </th>
            </tr>
          </thead>
          <tbody>
            {rows.map((row) => (
              <tr
                key={row.key}
                className="border-b border-slate-50 dark:border-slate-700/30 last:border-0"
              >
                <td className="px-4 py-2 text-slate-900 dark:text-slate-200 font-medium">
                  {row.label}
                </td>
                <td className="px-4 py-2 text-right text-slate-600 dark:text-slate-400">
                  {row.count}
                </td>
                <td className="px-4 py-2 text-right text-slate-600 dark:text-slate-400">
                  ${row.revenue.toFixed(2)}
                </td>
              </tr>
            ))}
            {rows.length === 0 && (
              <tr>
                <td
                  colSpan={3}
                  className="px-4 py-6 text-center text-slate-400 dark:text-slate-500 text-sm"
                >
                  No data
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

interface SalesBreakdownTablesProps {
  countryStats: RegionStat[];
  stateStats: RegionStat[];
}

export function SalesBreakdownTables({ countryStats, stateStats }: SalesBreakdownTablesProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      <BreakdownTable title="By Country" rows={countryStats} labelHeader="Country" />
      <BreakdownTable title="By US State" rows={stateStats} labelHeader="State" />
    </div>
  );
}
```

**Step 1: Commit**

```bash
git add src/components/salesmap/SalesBreakdownTables.tsx
git commit -m "feat(salesmap): add country and state breakdown tables"
```

---

## Task 10: Main `SalesMapView` component

**Files:**
- Create: `src/components/salesmap/SalesMapView.tsx`

```tsx
import { useState, useMemo } from 'react';
import { ShoppingBag, Globe, DollarSign } from 'lucide-react';
import { PageSection } from '@/components/layout/PageSection';
import { KpiCard } from '@/components/kpi/KpiCard';
import { useSalesOrders } from '@/hooks/useSalesOrders';
import { statsByUsState, statsByCountry } from '@/lib/salesMapData';
import { SalesMapUpload } from './SalesMapUpload';
import { UsMap } from './UsMap';
import { WorldMap } from './WorldMap';
import { SalesBreakdownTables } from './SalesBreakdownTables';

type MapView = 'us' | 'world';

interface SalesMapViewProps {
  isDark: boolean;
}

export function SalesMapView({ isDark }: SalesMapViewProps) {
  const { orders, merge, clear } = useSalesOrders();
  const [mapView, setMapView] = useState<MapView>('us');

  const stateStats = useMemo(() => statsByUsState(orders), [orders]);
  const countryStats = useMemo(() => statsByCountry(orders), [orders]);
  const totalRevenue = useMemo(
    () => orders.reduce((sum, o) => sum + o.orderValue, 0),
    [orders]
  );

  return (
    <>
      <PageSection title="Upload">
        <SalesMapUpload onMerge={merge} onClear={clear} totalOrders={orders.length} />
      </PageSection>

      {orders.length > 0 ? (
        <>
          <PageSection title="Summary">
            <div className="grid grid-cols-3 gap-3 sm:gap-4">
              <KpiCard
                label="Total Orders"
                value={orders.length.toLocaleString()}
                icon={<ShoppingBag size={18} />}
                accent="blue"
              />
              <KpiCard
                label="Total Revenue"
                value={`$${totalRevenue.toLocaleString('en-US', {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                })}`}
                icon={<DollarSign size={18} />}
                accent="green"
              />
              <KpiCard
                label="Countries"
                value={countryStats.length}
                icon={<Globe size={18} />}
                accent="blue"
              />
            </div>
          </PageSection>

          <PageSection title="Map">
            <div className="bg-white dark:bg-slate-800/60 rounded-2xl border border-slate-200 dark:border-slate-700/50 p-4 shadow-sm">
              <div className="flex gap-2 mb-4">
                {(['us', 'world'] as const).map((v) => (
                  <button
                    key={v}
                    onClick={() => setMapView(v)}
                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors cursor-pointer border-none ${
                      mapView === v
                        ? 'bg-blue-600 text-white'
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {v === 'us' ? 'US States' : 'World'}
                  </button>
                ))}
              </div>
              {mapView === 'us' ? (
                <UsMap stats={stateStats} isDark={isDark} />
              ) : (
                <WorldMap stats={countryStats} isDark={isDark} />
              )}
            </div>
          </PageSection>

          <PageSection title="Breakdown">
            <SalesBreakdownTables countryStats={countryStats} stateStats={stateStats} />
          </PageSection>
        </>
      ) : (
        <div className="flex flex-col items-center justify-center py-20 text-slate-400 dark:text-slate-500">
          <Globe size={48} className="mb-4 opacity-30" />
          <p className="text-base font-medium">No sales data yet</p>
          <p className="text-sm mt-1">Upload an Etsy sold-orders CSV above to get started</p>
        </div>
      )}
    </>
  );
}
```

**Step 1: Commit**

```bash
git add src/components/salesmap/SalesMapView.tsx
git commit -m "feat(salesmap): add main SalesMapView component"
```

---

## Task 11: Wire navigation and render

**Files:**
- Modify: `src/components/layout/Sidebar.tsx`
- Modify: `src/components/layout/BottomNav.tsx`
- Modify: `src/pages/Dashboard.tsx`

**`src/components/layout/Sidebar.tsx`** — add `Map` import and salesmap nav item:

```tsx
// Change import line to add Map:
import { LayoutDashboard, PackageSearch, ShoppingCart, BarChart2, Tag, Map } from 'lucide-react';

// Add to navItems array (after the seo entry):
{ id: 'salesmap', label: 'Sales Map', Icon: Map },
```

The existing `isSeo` logic already handles `salesmap` correctly — it will get the blue active style.

**`src/components/layout/BottomNav.tsx`** — same additions:

```tsx
// Change import line to add Map:
import { LayoutDashboard, PackageSearch, ShoppingCart, BarChart2, Tag, Map } from 'lucide-react';

// Add to navItems array (after seo entry):
{ id: 'salesmap', label: 'Sales Map', Icon: Map },
```

The existing `isSeo` check will also correctly give salesmap the blue active color.

**`src/pages/Dashboard.tsx`** — add import and render:

```tsx
// Add import at the top with other component imports:
import { SalesMapView } from '@/components/salesmap/SalesMapView';

// Add render block after the seo block (before the closing </div>):
{activeView === 'salesmap' && (
  <SalesMapView isDark={isDark} />
)}
```

**Step 1: Verify in dev server**

```bash
npm run dev
```

- Open app → "Sales Map" tab appears in sidebar and bottom nav
- Click it → empty state with upload zone visible
- Drop `EtsySoldOrders2025.csv` → map renders, KPIs show, tables show
- Refresh page → data still present (localStorage)
- Upload same CSV again → "+0 new · 792 skipped" badge appears
- Click "Clear All" → confirm → data gone, empty state returns
- Toggle "US States" / "World" → correct map renders
- Hover over states/countries → tooltip shows name, count, revenue

**Step 2: Fix any TypeScript errors**

```bash
npm run build
```

Expected: exits with code 0. Fix any reported errors before committing.

**Step 3: Commit**

```bash
git add src/components/layout/Sidebar.tsx src/components/layout/BottomNav.tsx src/pages/Dashboard.tsx
git commit -m "feat(salesmap): wire Sales Map tab into navigation and dashboard"
```
